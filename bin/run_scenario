#!/bin/bash

set -e
set -x

trap 'kill $(jobs -p) || true' EXIT

BASEDIR=`dirname $0`
pushd $BASEDIR > /dev/null
cd ..
BASEDIR=`pwd`
popd

if [[ "${JXAAS_HOME}" == "" ]]; then
  JXAAS_HOME=~/jxaas
fi

cd ${JXAAS_HOME}

if [ "$#" == "0" ]; then
	echo "Usage: $0 <testname> <scenarios...>"
	exit 1
fi

TEST=$1
shift

pkill -KILL jxaasd || true
pkill etcd || true
pkill -KILL jxaas-router || true

sudo juju destroy-environment --force -y local
juju bootstrap
juju set-env apt-http-proxy=http://10.0.3.1:8000
juju status

while (( "$#" )); do
  SCENARIO=$1
  . ${BASEDIR}/scenarios/${SCENARIO}

  shift
done

echo "Waiting 2 minutes for JXaaS to start"
sleep 120

${BASEDIR}/${TEST}

sleep 30

echo "Success!"

